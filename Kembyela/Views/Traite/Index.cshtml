@model List<Kembyela.Models.Traite>

@{
    ViewData["Title"] = "Liste des Lettres de Change";

    // Fonction pour déterminer si une lettre est en retard
    bool EstEnRetard(DateTime dateEcheance)
    {
        return dateEcheance.Date < DateTime.Now.Date;
    }

    // Compter les lettres payées
    int lettresPayees = Model?.Count(t => t.EstPayee) ?? 0;
    int lettresEnAttente = Model?.Count(t => !t.EstPayee && !EstEnRetard(t.DateEcheance)) ?? 0;
}

<div class="container-fluid px-4 py-4 kem-index-container">
    <!-- Messages d'alerte -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm mb-4 kem-alert" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle me-2"></i>
                <div>@TempData["SuccessMessage"]</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm mb-4 kem-alert" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-circle me-2"></i>
                <div>@TempData["ErrorMessage"]</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Section de recherche et filtres -->
    <div class="card border-0 shadow-sm mb-5 kem-card kem-search-card">
        <div class="card-header kem-card-header kem-search-header">
            <div class="d-flex align-items-center">
                <i class="fas fa-search me-2"></i>
                <h5 class="mb-0">Recherche et Filtres</h5>
            </div>
        </div>
        <div class="card-body">
            <form asp-action="Index" method="get" class="row g-3">
                <div class="col-lg-10 col-md-9">
                    <div class="input-group input-group-lg kem-search-input-group">
                        <span class="input-group-text kem-search-icon">
                            <i class="fas fa-search text-primary"></i>
                        </span>
                        <input type="text" class="form-control kem-search-input"
                               name="searchString"
                               value="@ViewData["CurrentFilter"]"
                               placeholder="Rechercher par Bénéficiaire, Payeur ou Banque...">
                        <button type="submit" class="btn btn-primary px-4 kem-btn kem-btn-search">
                            <i class="fas fa-search me-2"></i>Rechercher
                        </button>
                        @if (!string.IsNullOrEmpty(ViewData["CurrentFilter"]?.ToString()))
                        {
                            <a asp-action="Index" class="btn btn-outline-secondary px-4 kem-btn kem-btn-clear">
                                <i class="fas fa-times me-2"></i>Effacer
                            </a>
                        }
                    </div>
                    <small class="form-text text-muted mt-2 d-flex align-items-center kem-search-help">
                        <i class="fas fa-info-circle me-1"></i>
                        Recherche dans: Bénéficiaire (OrdreDe), Payeur (Payer), Banque
                    </small>
                </div>

                <div class="col-lg-2 col-md-3">
                    <div class="input-group input-group-lg kem-sort-input-group">
                        <span class="input-group-text kem-sort-icon">
                            <i class="fas fa-sort-amount-down text-primary"></i>
                        </span>
                        <select name="sortOrder" class="form-select kem-sort-select" onchange="this.form.submit()">
                            <option value="">Trier par...</option>
                            <option value="date_desc" selected="@(ViewData["CurrentSort"]?.ToString() == "date_desc")">Date création ↓</option>
                            <option value="" selected="@(string.IsNullOrEmpty(ViewData["CurrentSort"]?.ToString()))">Date création ↑</option>
                            <option value="echeance_asc" selected="@(ViewData["CurrentSort"]?.ToString() == "echeance_asc")">Échéance ↑</option>
                            <option value="echeance_desc" selected="@(ViewData["CurrentSort"]?.ToString() == "echeance_desc")">Échéance ↓</option>
                            <option value="montant_asc" selected="@(ViewData["CurrentSort"]?.ToString() == "montant_asc")">Montant ↑</option>
                            <option value="montant_desc" selected="@(ViewData["CurrentSort"]?.ToString() == "montant_desc")">Montant ↓</option>
                            <option value="paye" selected="@(ViewData["CurrentSort"]?.ToString() == "paye")">Payées</option>
                            <option value="nonpaye" selected="@(ViewData["CurrentSort"]?.ToString() == "nonpaye")">Non payées</option>
                        </select>
                    </div>
                </div>
            </form>

            <!-- Résumé de recherche -->
            @if (!string.IsNullOrEmpty(ViewData["CurrentFilter"]?.ToString()))
            {
                <div class="mt-4 alert alert-info border-0 shadow-sm kem-search-summary">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle fa-lg me-3"></i>
                        <div>
                            <strong>Résultats de recherche :</strong>
                            <span class="fw-bold">@ViewData["SearchCount"]</span> lettre(s) trouvée(s)
                            sur <span class="fw-bold">@ViewData["TotalCount"]</span> au total.
                            <br>
                            <small class="text-dark">Terme recherché : "<strong>@ViewData["CurrentFilter"]</strong>"</small>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Cartes de statistiques -->
    <div class="row g-4 mb-5 kem-stats-row">
        <div class="col-xl-3 col-lg-6">
            <div class="card border-0 shadow-sm h-100 kem-stats-card kem-stats-total">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="kem-stats-icon">
                            <i class="fas fa-file-contract fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Total Lettres</h6>
                            <h2 class="mb-0 fw-bold">@ViewData["TotalCount"]</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-lg-6">
            <div class="card border-0 shadow-sm h-100 kem-stats-card kem-stats-paid">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="kem-stats-icon">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Payées</h6>
                            <h2 class="mb-0 fw-bold">@lettresPayees</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-lg-6">
            <div class="card border-0 shadow-sm h-100 kem-stats-card kem-stats-late">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="kem-stats-icon">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">En Retard</h6>
                            <h2 class="mb-0 fw-bold">@ViewData["LettresEnRetard"]</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-lg-6">
            <div class="card border-0 shadow-sm h-100 kem-stats-card kem-stats-pending">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="kem-stats-icon">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">En Attente</h6>
                            <h2 class="mb-0 fw-bold">@lettresEnAttente</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau des lettres de change -->
    <div class="card border-0 shadow-sm kem-data-card">
        <div class="card-header kem-card-header kem-data-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0 kem-data-title">
                        <i class="fas fa-list me-2 text-primary"></i>
                        @if (!string.IsNullOrEmpty(ViewData["CurrentFilter"]?.ToString()))
                        {
                            <span>Résultats de recherche (@Model.Count)</span>
                        }
                        else
                        {
                            <span>Toutes les lettres de change (@Model.Count)</span>
                        }
                    </h5>
                    @if (ViewData["LettresEnRetard"] != null && (int)ViewData["LettresEnRetard"] > 0)
                    {
                        <span class="badge kem-badge-late">
                            <i class="fas fa-exclamation-circle me-1"></i>
                            @ViewData["LettresEnRetard"] en retard
                        </span>
                    }

                    @if (lettresPayees > 0)
                    {
                        <span class="badge kem-badge-paid ms-2">
                            <i class="fas fa-check-circle me-1"></i>
                            @lettresPayees payée(s)
                        </span>
                    }
                </div>
                <div class="text-muted small kem-sort-info">
                    <i class="fas fa-sort me-1"></i>
                    @switch (ViewData["CurrentSort"]?.ToString())
                    {
                        case "date_desc":
                            <span>Tri: Date création ↓</span>
                            break;
                        case "echeance_asc":
                            <span>Tri: Échéance ↑</span>
                            break;
                        case "echeance_desc":
                            <span>Tri: Échéance ↓</span>
                            break;
                        case "montant_asc":
                            <span>Tri: Montant ↑</span>
                            break;
                        case "montant_desc":
                            <span>Tri: Montant ↓</span>
                            break;
                        case "paye":
                            <span>Tri: Payées</span>
                            break;
                        case "nonpaye":
                            <span>Tri: Non payées</span>
                            break;
                        default:
                            <span>Tri: Date création ↑</span>
                            break;
                    }
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 kem-data-table">
                    <thead class="table-light">
                        <tr>
                            <th class="py-3 border-bottom">Statut</th>
                            <th class="py-3 border-bottom">Date Création</th>
                            <th class="py-3 border-bottom">Échéance</th>
                            <th class="py-3 border-bottom">Bénéficiaire</th>
                            <th class="py-3 border-bottom">Montant</th>
                            <th class="py-3 border-bottom">Ville</th>
                            <th class="py-3 border-bottom text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var traite in Model)
                        {
                            bool estEnRetard = EstEnRetard(traite.DateEcheance);
                            int joursRetard = estEnRetard ? (DateTime.Now.Date - traite.DateEcheance.Date).Days : 0;
                            int joursRestants = !estEnRetard ? (traite.DateEcheance.Date - DateTime.Now.Date).Days : 0;

                            <tr class="@(estEnRetard && !traite.EstPayee ? "kem-row-late" : "")
                                              @(traite.EstPayee ? "kem-row-paid" : "") border-bottom">

                                <!-- Colonne Statut -->
                                <td class="align-middle">
                                    <div class="d-flex flex-column">
                                        @if (traite.EstPayee)
                                        {
                                            <span class="badge kem-badge-paid-full mb-1">
                                                <i class="fas fa-check-circle me-1"></i>Payée
                                            </span>
                                            <small class="text-success kem-payment-date">
                                                <i class="fas fa-calendar-check me-1"></i>
                                                Paiement confirmé
                                            </small>
                                        }
                                        else if (estEnRetard)
                                        {
                                            <span class="badge kem-badge-late-full mb-1">
                                                <i class="fas fa-exclamation-circle me-1"></i>En retard
                                                @if (joursRetard > 0)
                                                {
                                                    <span class="ms-1">(@joursRetard j)</span>
                                                }
                                            </span>
                                            <small class="text-danger kem-late-warning">
                                                <i class="fas fa-clock me-1"></i>
                                                Délai dépassé
                                            </small>
                                        }
                                        else if (traite.DateEcheance.Date == DateTime.Now.Date)
                                        {
                                            <span class="badge kem-badge-today mb-1">
                                                <i class="fas fa-calendar-day me-1"></i>Échéance aujourd'hui
                                            </span>
                                            <small class="text-warning kem-today-warning">
                                                <i class="fas fa-exclamation me-1"></i>
                                                À régler
                                            </small>
                                        }
                                        else
                                        {
                                            <span class="badge kem-badge-pending mb-1">
                                                <i class="fas fa-clock me-1"></i>En attente
                                            </span>
                                            @if (joursRestants > 0)
                                            {
                                                <small class="text-info kem-days-left">
                                                    <i class="fas fa-calendar-alt me-1"></i>
                                                    @joursRestants jour(s) restant(s)
                                                </small>
                                            }
                                        }
                                    </div>
                                </td>

                                <!-- Colonne Date de création -->
                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold kem-date">@traite.CreatedAt.ToString("dd/MM/yyyy")</span>
                                        <small class="text-muted kem-time">
                                            <i class="fas fa-clock me-1"></i>@traite.CreatedAt.ToString("HH:mm")
                                        </small>
                                    </div>
                                </td>

                                <!-- Colonne Échéance -->
                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold kem-date">@traite.DateEcheance.ToString("dd/MM/yyyy")</span>
                                    </div>
                                </td>

                                <!-- Colonne Bénéficiaire -->
                                <td>
                                    <div class="d-flex flex-column">
                                        <strong class="text-primary kem-beneficiary">@traite.OrdreDe</strong>
                                        <small class="text-muted kem-payer">
                                            <i class="fas fa-user me-1"></i>Payeur: @traite.Payer
                                        </small>
                                        @if (!string.IsNullOrEmpty(traite.Aval))
                                        {
                                            <small class="text-info mt-1 kem-aval">
                                                <i class="fas fa-shield-alt me-1"></i>Aval: @traite.Aval
                                            </small>
                                        }
                                    </div>
                                </td>

                                <!-- Colonne Montant -->
                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold text-success kem-amount">@traite.GetMontantFormatted()</span>
                                        <small class="text-muted kem-amount-letters"
                                               title="@traite.MontantEnLettres">
                                            <i class="fas fa-file-alt me-1"></i>
                                            @{
                                                var mots = traite.MontantEnLettres.Split(' ');
                                                var apercu = mots.Length > 4 ? string.Join(" ", mots.Take(4)) + "..." : traite.MontantEnLettres;
                                            }
                                            @apercu
                                        </small>
                                    </div>
                                </td>

                                <!-- Colonne Ville -->
                                <td>
                                    <span class="badge kem-badge-city">
                                        <i class="fas fa-map-marker-alt me-1"></i>@traite.Ville
                                    </span>
                                </td>

                                <!-- Colonne Actions -->
                                <td class="pe-4 text-end kem-action-buttons">
                                    <div class="btn-group shadow-sm kem-btn-group" role="group">
                                        <!-- Solution SIMPLE avec formulaire POST -->
                                        @if (!traite.EstPayee)
                                        {
                                            <form method="post" action="@Url.Action("MarquerCommePayee", "Traite")" style="display:inline;">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@traite.Id" />
                                                <button type="submit" class="btn btn-success btn-sm px-3 kem-btn-action kem-btn-pay"
                                                        title="Marquer comme payée"
                                                        onclick="return confirm('Voulez-vous marquer cette lettre comme payée ?')">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </form>
                                        }
                                        else
                                        {
                                            <form method="post" action="@Url.Action("MarquerCommeNonPayee", "Traite")" style="display:inline;">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@traite.Id" />
                                                <button type="submit" class="btn btn-warning btn-sm px-3 kem-btn-action kem-btn-unpay"
                                                        title="Marquer comme non payée"
                                                        onclick="return confirm('Voulez-vous marquer cette lettre comme non payée ?')">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </form>
                                        }

                                        <!-- Bouton Imprimer -->
                                        <a asp-action="Print" asp-route-id="@traite.Id"
                                           class="btn btn-outline-primary btn-sm px-3 kem-btn-action kem-btn-print"
                                           target="_blank"
                                           title="Imprimer PDF">
                                            <i class="fas fa-print"></i>
                                        </a>

                                        <!-- Bouton Dupliquer -->
                                        <form method="post" action="@Url.Action("Duplicate", "Traite")" style="display:inline;">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@traite.Id" />
                                            <button type="submit" class="btn btn-outline-warning btn-sm px-3 kem-btn-action kem-btn-duplicate"
                                                    title="Dupliquer"
                                                    onclick="return confirm('Voulez-vous dupliquer cette lettre de change ?')">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </form>

                                        <!-- Bouton Supprimer -->
                                        <a asp-action="Delete" asp-route-id="@traite.Id"
                                           class="btn btn-outline-danger btn-sm px-3 kem-btn-action kem-btn-delete"
                                           title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer kem-data-footer">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="text-muted kem-display-info">
                        <i class="fas fa-chart-bar me-1"></i>
                        Affiché: <strong>@Model.Count</strong> lettre(s)
                        @if (!string.IsNullOrEmpty(ViewData["CurrentFilter"]?.ToString()))
                        {
                            <span class="text-primary ms-2">
                                (sur <strong>@ViewData["TotalCount"]</strong> au total)
                            </span>
                        }
                    </span>
                    <div class="mt-1">
                        <span class="badge kem-badge-paid-full me-2">
                            <i class="fas fa-check-circle me-1"></i>
                            Payées: @lettresPayees
                        </span>
                        <span class="badge kem-badge-pending me-2">
                            <i class="fas fa-clock me-1"></i>
                            En attente: @lettresEnAttente
                        </span>
                        @if (ViewData["LettresEnRetard"] != null && (int)ViewData["LettresEnRetard"] > 0)
                        {
                            <span class="badge kem-badge-late-full">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                En retard: @ViewData["LettresEnRetard"]
                            </span>
                        }
                    </div>
                </div>
                <div class="text-end">
                    <div class="d-flex flex-column align-items-end">
                        <span class="fw-bold text-success kem-total-amount">
                            <i class="fas fa-money-bill-wave me-1"></i>
                            Montant total: @Model.Sum(t => t.Montant).ToString("N3") DT
                        </span>
                        @{
                            decimal montantPaye = Model.Where(t => t.EstPayee).Sum(t => t.Montant);
                        }
                        <small class="text-success mt-1 kem-paid-amount">
                            <i class="fas fa-check-circle me-1"></i>
                            Montant payé: @montantPaye.ToString("N3") DT
                        </small>
                        @if (ViewData["LettresEnRetard"] != null && (int)ViewData["LettresEnRetard"] > 0)
                        {
                            <small class="text-danger mt-1 kem-late-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                @ViewData["LettresEnRetard"] lettre(s) nécessite(nt) une attention particulière
                            </small>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message si aucune lettre -->
    @if (Model == null || !Model.Any())
    {
        <div class="text-center py-5 my-5 kem-empty-state">
            <div class="kem-empty-icon">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
            @if (!string.IsNullOrEmpty(ViewData["CurrentFilter"]?.ToString()))
            {
                <h2 class="text-muted mb-3">Aucun résultat trouvé</h2>
                <p class="lead text-muted mb-4">Aucune lettre de change ne correspond à "<strong>@ViewData["CurrentFilter"]</strong>"</p>
                <a asp-action="Index" class="btn btn-outline-primary btn-lg px-5 kem-btn kem-btn-empty">
                    <i class="fas fa-list me-2"></i>Voir toutes les lettres
                </a>
            }
            else
            {
                <h2 class="text-muted mb-3">Aucune lettre de change</h2>
                <p class="lead text-muted mb-4">Commencez par créer votre première lettre de change</p>
                <a asp-action="Create" class="btn btn-primary btn-lg px-5 shadow-sm kem-btn kem-btn-empty-primary">
                    <i class="fas fa-plus-circle me-2"></i>Créer la première lettre
                </a>
            }
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Style pour les boutons
            $('.kem-btn-action').hover(
                function() {
                    $(this).css('transform', 'scale(1.05)');
                },
                function() {
                    $(this).css('transform', 'scale(1)');
                }
            );

            // Focus sur le champ de recherche
            @if (!string.IsNullOrEmpty(ViewData["CurrentFilter"]?.ToString()))
            {
                    <text>
                    setTimeout(function() {
                        $('input[name="searchString"]').focus().select();
                    }, 300);
                    </text>
            }
        });
    </script>
}

<style>
    /* Styles pour les badges de statut */
    .kem-badge-paid-full {
        background-color: #28a745;
        color: white;
        padding: 0.35em 0.65em;
    }

    .kem-badge-pending {
        background-color: #6c757d;
        color: white;
        padding: 0.35em 0.65em;
    }

    .kem-badge-late-full {
        background-color: #dc3545;
        color: white;
        padding: 0.35em 0.65em;
    }

    .kem-badge-today {
        background-color: #ffc107;
        color: #212529;
        padding: 0.35em 0.65em;
    }

    /* Styles pour les lignes du tableau */
    .kem-row-paid {
        background-color: rgba(40, 167, 69, 0.05);
    }

    .kem-row-late {
        background-color: rgba(220, 53, 69, 0.05);
    }

    /* Styles pour les boutons */
    .kem-btn-pay {
        background-color: #28a745;
        color: white;
        border: none;
    }

        .kem-btn-pay:hover {
            background-color: #218838;
            color: white;
        }

    .kem-btn-unpay {
        background-color: #ffc107;
        color: #212529;
        border: none;
    }

        .kem-btn-unpay:hover {
            background-color: #e0a800;
            color: #212529;
        }

    /* Badges dans le header */
    .kem-badge-paid {
        background-color: #28a745;
        color: white;
    }

    .kem-badge-late {
        background-color: #dc3545;
        color: white;
    }

    /* Informations de paiement */
    .kem-payment-date {
        font-size: 0.75rem;
    }

    .kem-late-warning {
        font-size: 0.75rem;
    }

    .kem-today-warning {
        font-size: 0.75rem;
    }

    .kem-days-left {
        font-size: 0.75rem;
    }

    /* Montants payés */
    .kem-paid-amount {
        font-size: 0.875rem;
    }

    /* Cartes de statistiques */
    .kem-stats-paid {
        border-left: 4px solid #28a745 !important;
    }

    .kem-stats-pending {
        border-left: 4px solid #6c757d !important;
    }
</style>